import React, { useState, useEffect } from "react";
import { Table, Form, Button, Modal } from "react-bootstrap";
import { FaCheck } from "react-icons/fa6";
import axios from "axios";

const TwelfthStepThreeView = () => {
  const [show, setShow] = useState(false);

  const [bankOptions, setBankOptions] = useState([]);

  useEffect(() => {
    const fetchBankList = async () => {
      try {
        const res = await axios.get(
          "https://brjobsedu.com/Nandagora/api2/Bankdetails/"
        );
        if (res.data?.length) setBankOptions(res.data); // store array of objects
      } catch (err) {
        console.error(
          "Error fetching bank list:",
          err.response?.data || err.message
        );
      }
    };

    fetchBankList();
  }, []);

  // Static fields
  const [staticData, setStaticData] = useState({
    socio_eco: "",
    bhoomi_type: "",
    bhoomi_typer: "",
    bhoomi_shetr: "",
    curr_amt: "",
    res_type: "",
    rooms: "",
    area: "",
    curr_pri: "",
    adhar_no: "",
    girl_name: "",
    district: "",
    project: "",
  });

  // Rows
  const [bankRows, setBankRows] = useState([
    { det1: "", det2: "", det3: "", det4: "" },
  ]);
  const [vehicleRows, setVehicleRows] = useState([
    {
      vec_model: "",
      vec_number: "",
      vec_amt: "",
      vec_other: "",
      adhar_no: "",
      girl_name: "",
      district: "",
      project: "",
    },
  ]);
  const [electricityRows, setElectricityRows] = useState([
    { acno: "", date: "", amount: "" },
  ]);
  const [waterBillRow, setWaterBillRow] = useState({
    acno: "",
    date: "",
    amount: "",
  });

  const handleShow = () => setShow(true);
  const handleClose = () => setShow(false);

  // handle changes
  const handleStaticChange = (field, value) =>
    setStaticData((prev) => ({ ...prev, [field]: value }));
  const handleBankChange = (index, field, value) =>
    setBankRows((prev) => {
      const updated = [...prev];
      updated[index][field] = value;
      return updated;
    });
  const handleVehicleChange = (index, field, value) =>
    setVehicleRows((prev) => {
      const updated = [...prev];
      updated[index][field] = value;
      return updated;
    });
  const handleElectricityChange = (index, field, value) =>
    setElectricityRows((prev) => {
      const updated = [...prev];
      updated[index][field] = value;
      return updated;
    });
  const handleWaterBillChange = (field, value) =>
    setWaterBillRow((prev) => ({ ...prev, [field]: value }));

  //  add/delete
  const addBankRow = () =>
    setBankRows([...bankRows, { det1: "", det2: "", det3: "", det4: "" }]);
  const deleteBankRow = (index) =>
    setBankRows(bankRows.filter((_, i) => i !== index));

  const addVehicleRow = () =>
    setVehicleRows([
      ...vehicleRows,
      {
        vec_model: "",
        vec_number: "",
        vec_amt: "",
        vec_other: "",
        adhar_no: "",
        girl_name: "",
        district: "",
        project: "",
      },
    ]);
  const deleteVehicleRow = (index) =>
    setVehicleRows(vehicleRows.filter((_, i) => i !== index));

  // fetch existing data
  useEffect(() => {
    const user_id = localStorage.getItem("user_id");
    if (!user_id) return;

    const fetchStep3a = async () => {
      try {
        const res = await axios.get(
          `https://brjobsedu.com/Nandagora/api4/step3a/${user_id}/`
        );
        if (res.data) setStaticData(res.data);
      } catch (err) {
        console.error(
          "Error fetching Step3a:",
          err.response?.data || err.message
        );
      }
    };

    const fetchStep3b = async () => {
      try {
        const res = await axios.get(
          `https://brjobsedu.com/Nandagora/api4/step3b/${user_id}/`
        );
        if (res.data?.length) setBankRows(res.data);
      } catch (err) {
        console.error(
          "Error fetching Step3b:",
          err.response?.data || err.message
        );
      }
    };

    const fetchStep3Vehicle = async () => {
      try {
        const res = await axios.get(
          `https://brjobsedu.com/Nandagora/api4/stepthreevahanupadte/${user_id}`
        );
        if (res.data?.length)
          setVehicleRows(
            res.data.map((v) => ({
              ...v,
              adhar_no: v.adhar_no || "",
              girl_name: v.girl_name || "",
              district: v.district || "",
              project: v.project || "",
            }))
          );
      } catch (err) {
        console.error(
          "Error fetching Step3 Vehicle:",
          err.response?.data || err.message
        );
      }
    };

    const fetchStep3Bills = async () => {
      try {
        const res = await axios.get(
          `https://brjobsedu.com/Nandagora/api4/Bills_update/${user_id}`
        );
        if (res.data?.length) {
          const electricityData = res.data.filter(
            (item) => item.type === "electric"
          );
          const waterData = res.data.find((item) => item.type === "water");
          if (electricityData.length) setElectricityRows(electricityData);
          if (waterData) setWaterBillRow(waterData);
        }
      } catch (err) {
        console.error(
          "Error fetching Step3 Bills:",
          err.response?.data || err.message
        );
      }
    };

    fetchStep3a();
    fetchStep3b();
    fetchStep3Vehicle();
    fetchStep3Bills();
  }, []);

  // ЁЯФ╣ Update all data
  const updateAll = async () => {
    const user_id = localStorage.getItem("user_id");
    if (!user_id) return alert("User ID not found!");

    try {
      // Step3a (static fields)
      await axios.put(
        `https://brjobsedu.com/Nandagora/api4/step3aupdate/${user_id}/`,
        staticData
      );

      // Step3b (Bank) - send entire array in one PUT
      const bankPayload = bankRows.map((row) => ({
        ...row,
        user: user_id,
        type: "account",
        adhar_no: row.adhar_no || staticData.adhar_no,
        girl_name: row.girl_name || staticData.girl_name,
        district: row.district || staticData.district,
        project: row.project || staticData.project,
      }));
      await axios.put(
        `https://brjobsedu.com/Nandagora/api4/step3bupate/${user_id}`,
        bankPayload
      );

      // Vehicles - send entire array in one PUT
      const vehiclePayload = vehicleRows.map((row) => ({
        ...row,
        user: user_id,
        adhar_no: row.adhar_no || staticData.adhar_no,
        girl_name: row.girl_name || staticData.girl_name,
        district: row.district || staticData.district,
        project: row.project || staticData.project,
      }));
      await axios.put(
        `https://brjobsedu.com/Nandagora/api4/stepthreevahanupadte/${user_id}`,
        vehiclePayload
      );

      // Combine electricity rows and water row into one payload
      const billsPayload = [
        ...electricityRows.map((row) => ({
          ...row,
          user: user_id,
          type: "electric",
          adhar_no: row.adhar_no || staticData.adhar_no,
          girl_name: row.girl_name || staticData.girl_name,
          district: row.district || staticData.district,
          project: row.project || staticData.project,
        })),
        {
          ...waterBillRow,
          user: user_id,
          type: "water",
          adhar_no: waterBillRow.adhar_no || staticData.adhar_no,
          girl_name: waterBillRow.girl_name || staticData.girl_name,
          district: waterBillRow.district || staticData.district,
          project: waterBillRow.project || staticData.project,
        },
      ];

      // Single PUT for all bills
      await axios.put(
        `https://brjobsedu.com/Nandagora/api4/Bills_update/${user_id}`,
        billsPayload
      );

      alert("рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЕрдкрдбреЗрдЯ рд╣реЛ рдЧрдИ!");
      window.location.href = "/TwelfthStepFour";
    } catch (err) {
      console.error("Update failed:", err.response?.data || err.message);
      alert("рдЕрдкрдбреЗрдЯ рдЕрд╕рдлрд▓ рд░рд╣рд╛, рдХреГрдкрдпрд╛ рдХрдВрд╕реЛрд▓ рджреЗрдЦреЗрдВред");
    }
  };

  return (
    <>
      <div
        onClick={handleShow}
        style={{ cursor: "pointer" }}
        className="nd-step2"
      >
        <h3>
          <FaCheck /> Step 3 : рдЕрддрд┐рд░рд┐рдХреНрдд рдЬрд╛рдирдХрд╛рд░реА (Click to View)
        </h3>
      </div>

      <Modal show={show} onHide={handleClose} size="lg" scrollable>
        <Modal.Header closeButton>
          <Modal.Title>Step 3 : рд╡рд┐рд╡рд░рдг</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form>
            {/* Static Fields */}
            <h5 className="text-center">рд╕рд╛рдорд╛рдЬрд┐рдХ рдФрд░ рднреВрдорд┐ рд╡рд┐рд╡рд░рдг</h5>
            <Table bordered responsive className="nd-born-table">
              <tbody>
                <tr>
                  <td>
                    {" "}
                    1. рд╕рд╛рдорд╛рдЬрд┐рдХ рдЖрд░реНрдерд┐рдХ рдЬрд╛рддрд┐ рдЬрдирдЧрдгрдирд╛ рдореЗрдВ рдкрд░рд┐рд╡рд╛рд░ рдХреА рд╕реНрдерд┐рддрд┐ рдХрд╛ рд╡рд┐рд╡рд░рдг
                  </td>
                  <td>
                    <div>
                      <strong>рдкреНрд░рдХрд╛рд░ рдЪреБрдиреЗ</strong>
                      <Form.Select
                        value={staticData.socio_eco}
                        onChange={(e) =>
                          handleStaticChange("socio_eco", e.target.value)
                        }
                      >
                        <option value="рд╕реНрд╡рддрдГ рд╕рдореНрдорд┐рд▓рд┐рдд">рд╕реНрд╡рддрдГ рд╕рдореНрдорд┐рд▓рд┐рдд</option>
                        <option value="рд╕рдореНрдорд┐рд▓рд┐рдд рдирд╣реА">рд╕рдореНрдорд┐рд▓рд┐рдд рдирд╣реА</option>
                      </Form.Select>
                    </div>
                  </td>
                </tr>

                {/* Row 2 */}
                <tr>
                  <td>2. рд╡рд╛рд▓рд┐рдХрд╛ рдХреЗ рдкрд░рд┐рд╡рд╛рд░ рдХреЗ рдкрд╛рд╕ рдЙрдкрд▓рдмреНрдз рднреВрдорд┐ рдХрд╛ рдкреНрд░рдХрд╛рд░</td>
                  <td>
                    <div>
                      <strong>рднреВрдорд┐ рдХрд╛ рдкреНрд░рдХрд╛рд░:</strong>
                      <Form.Select
                        value={staticData.bhoomi_type}
                        onChange={(e) =>
                          handleStaticChange("bhoomi_type", e.target.value)
                        }
                      >
                        <option value="">рднреВрдорд┐ рдкреНрд░рдХрд╛рд░ рдЪреБрдиреЗ</option>
                        <option value="рдкреИрддреГрдХ рднреВрдорд┐">рдкреИрддреГрдХ рднреВрдорд┐</option>
                        <option value="рдХреНрд░рдп рднреВрдорд┐">рдХреНрд░рдп рднреВрдорд┐</option>
                        <option value="рдкрдЯреНрдЯрд╛/Lease">рдкрдЯреНрдЯрд╛/Lease</option>
                        <option value="рднреВрдорд┐рд╣реАрди">рднреВрдорд┐рд╣реАрди</option>
                      </Form.Select>
                    </div>
                  </td>
                </tr>

                {/* Row 3 */}
                <tr>
                  <td>
                    3. рд╡рд╛рд▓рд┐рдХрд╛ рдХреЗ рдкрд░рд┐рд╡рд╛рд░ рдХреЗ рдкрд╛рд╕ рдЖрд╡рд╛рд╕реАрдп рдЙрдкрд▓рдмреНрдз рднреВрдорд┐ рдХрд╛ рдкреНрд░рдХрд╛рд░
                  </td>
                  <td>
                    <div>
                      <strong>рд╕рд┐рдВрдЪрд╛рдИ рдХрд╛ рд╕рд╛рдзрди:</strong>
                      <Form.Select
                        value={staticData.bhoomi_typer}
                        onChange={(e) =>
                          handleStaticChange("bhoomi_typer", e.target.value)
                        }
                      >
                        <option value="">рдЖрд╡рд╛рд╕реАрдп рднреВрдорд┐ рдкреНрд░рдХрд╛рд░ рдЪреБрдиреЗ </option>
                        <option value="рдкреИрддреГрдХ рднреВрдорд┐">рдкреИрддреГрдХ рднреВрдорд┐</option>
                        <option value="рд░рдЬрд┐рд╕реНрдЯреНрд░реА">рд░рдЬрд┐рд╕реНрдЯреНрд░реА</option>
                        <option value="рдкрдЯреНрдЯреЗ рдХреА рднреВрдорд┐">рдкрдЯреНрдЯреЗ рдХреА рднреВрдорд┐</option>
                        <option value="рдХрд┐рд░рд╛рдпрд╛">рдХрд┐рд░рд╛рдпрд╛</option>
                      </Form.Select>
                    </div>
                  </td>
                </tr>

                {/* Row 4 */}
                <tr>
                  <td>
                    {" "}
                    4. рдмрд╛рд▓рд┐рдХрд╛ рдХреЗ рдкрд░рд┐рд╡рд╛рд░ рдХреЗ рдкрд╛рд╕ рдЙрдкрд▓рдмреНрдз рдХреБрд▓ (рдХреГрд╖рд┐/рдЖрд╡рд╛рд╕реАрдп) рднреВрдорд┐
                  </td>
                  <td>
                    <div className="mb-2">
                      <strong>i.) рднреВрдорд┐ рдХрд╛ рдХреНрд╖реЗрддреНрд░рдлрд▓ (рд╣реЗрдХреНрдЯреЗрдпрд░ рдореЗрдВ)</strong>
                      <Form.Control
                        type="number"
                        placeholder="рднреВрдорд┐ рдХреНрд╖реЗрддреНрд░рдлрд▓"
                        value={staticData.bhoomi_shetr}
                        onChange={(e) =>
                          handleStaticChange("bhoomi_shetr", e.target.value)
                        }
                      />
                    </div>
                    <div>
                      <strong>ii.) рд╡рд░реНрддрдорд╛рди рдореВрд▓реНрдп</strong>
                      <Form.Control
                        type="number"
                        placeholder="рд╡рд░реНрддрдорд╛рди рдореВрд▓реНрдп (тВ╣)"
                        value={staticData.curr_amt}
                        onChange={(e) =>
                          handleStaticChange("curr_amt", e.target.value)
                        }
                      />
                    </div>
                  </td>
                </tr>

                {/* Row 5 */}
                <tr>
                  <td>5. рдЖрд╡рд╛рд╕ рдХрд╛ рд╡рд┐рд╡рд░рдг</td>
                  <td>
                    <div className="mb-2">
                      <strong>рдЖрд╡рд╛рд╕реАрдп рднреВрдорд┐ рдкреНрд░рдХрд╛рд░:</strong>
                      <Form.Select
                        value={staticData.res_type}
                        onChange={(e) =>
                          handleStaticChange("res_type", e.target.value)
                        }
                      >
                        <option value="">рдЖрд╡рд╛рд╕реАрдп рднреВрдорд┐ рдкреНрд░рдХрд╛рд░ рдЪреБрдиреЗ</option>
                        <option value="рдХрдЪреНрдЪрд╛">рдХрдЪреНрдЪрд╛</option>
                        <option value="рдкрдХреНрдХрд╛">рдкрдХреНрдХрд╛</option>
                      </Form.Select>
                    </div>

                    <div className="mb-2">
                      <strong>рдХрдХреНрд╖реЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛:</strong>
                      <Form.Control
                        type="number"
                        placeholder="рдХрдХреНрд╖реЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛"
                        value={staticData.rooms}
                        onChange={(e) =>
                          handleStaticChange("rooms", e.target.value)
                        }
                      />
                    </div>

                    <div className="mb-2">
                      <strong>рдХреНрд╖реЗрддреНрд░рдлрд▓ (рд╣реЗрдХреНрдЯреЗрдпрд░ рдореЗрдВ):</strong>
                      <Form.Control
                        type="number"
                        placeholder="рдХреНрд╖реЗрддреНрд░рдлрд▓ рд╣реЗрдХреНрдЯреЗрдпрд░ рдореЗрдВ"
                        value={staticData.area}
                        onChange={(e) =>
                          handleStaticChange("area", e.target.value)
                        }
                      />
                    </div>

                    <div>
                      <strong>рд╡рд░реНрддрдорд╛рди рдореВрд▓реНрдп (тВ╣):</strong>
                      <Form.Control
                        type="number"
                        placeholder="рд╡рд░реНрддрдорд╛рди рдореВрд▓реНрдп (тВ╣)"
                        value={staticData.curr_pri}
                        onChange={(e) =>
                          handleStaticChange("curr_pri", e.target.value)
                        }
                      />
                    </div>
                  </td>
                </tr>
              </tbody>
            </Table>

            <h5 className="text-center mt-3">рдмреИрдВрдХ рд╡рд┐рд╡рд░рдг</h5>
            <Table bordered responsive className="nd-born-table">
              <thead className="nd-born-thead">
                <tr>
                  <th>рдХреНрд░рдо рд╕рдВреж</th>
                  <th>рд╕рджрд╕реНрдп рдХрд╛ рдирд╛рдо</th>
                  <th>рдмреИрдВрдХ рдХрд╛ рдирд╛рдо</th>
                  <th>рдЦрд╛рддрд╛ рд╕рдВрдЦреНрдпрд╛</th>
                  <th>рдХреБрд▓ рдЬрдорд╛ рдзрдирд░рд╛рд╢рд┐ (тВ╣)</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {bankRows.map((row, index) => {
                  const optionsWithPrev = row.det2
                    ? bankOptions.some((b) => b.bank_name === row.det2)
                      ? bankOptions
                      : [...bankOptions, { id: "old", bank_name: row.det2 }]
                    : bankOptions;

                  return (
                    <tr key={index}>
                      <td>{index + 1}</td>
                      <td>
                        <Form.Control
                          value={row.det1}
                          onChange={(e) =>
                            handleBankChange(index, "det1", e.target.value)
                          }
                        />
                      </td>
                      <td>
                        <Form.Select
                          value={row.det2 || ""}
                          onChange={(e) =>
                            handleBankChange(index, "det2", e.target.value)
                          }
                        >
                          {optionsWithPrev.map((bank) => (
                            <option key={bank.id} value={bank.bank_name}>
                              {bank.bank_name}
                            </option>
                          ))}
                        </Form.Select>
                      </td>
                      <td>
                        <Form.Control
                          value={row.det3}
                          onChange={(e) =>
                            handleBankChange(index, "det3", e.target.value)
                          }
                        />
                      </td>
                      <td>
                        <Form.Control
                          value={row.det4}
                          onChange={(e) =>
                            handleBankChange(index, "det4", e.target.value)
                          }
                        />
                      </td>
                      <td>
                        <Button
                          variant="danger"
                          size="sm"
                          onClick={() => deleteBankRow(index)}
                        >
                          Delete
                        </Button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </Table>

            {/* Add Bank Row Button */}
            <Button className="nd-born-thead" onClick={addBankRow}>
              + Add Row
            </Button>

            {/* Vehicle Table */}
            <h5 className="text-center mt-3">рд╡рд╛рд╣рди рд╡рд┐рд╡рд░рдг</h5>
            <Table bordered responsive className="nd-born-table">
              <thead className="nd-born-thead">
                <tr>
                  <th>рдХреНрд░рдо рд╕рдВреж</th>
                  <th>рд╡рд╛рд╣рди рдХрд╛ рдореЗрдХ рдПрдВрдб рдореЙрдбрд▓</th>
                  <th>рд╡рд╛рд╣рди рдХреА рд╕рдВрдЦреНрдпрд╛</th>
                  <th>рдЕрдиреБрдорд╛рдирд┐рдд рдореВрд▓реНрдп</th>
                  <th>рдЕрдиреНрдп рд╡рд┐рд╡рд░рдг</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {vehicleRows.map((row, index) => (
                  <tr key={index}>
                    <td>{index + 1}</td>
                    <td>
                      <Form.Control
                        value={row.vec_model}
                        onChange={(e) =>
                          handleVehicleChange(
                            index,
                            "vec_model",
                            e.target.value
                          )
                        }
                      />
                    </td>
                    <td>
                      <Form.Control
                        value={row.vec_number}
                        onChange={(e) =>
                          handleVehicleChange(
                            index,
                            "vec_number",
                            e.target.value
                          )
                        }
                      />
                    </td>
                    <td>
                      <Form.Control
                        value={row.vec_amt}
                        onChange={(e) =>
                          handleVehicleChange(index, "vec_amt", e.target.value)
                        }
                      />
                    </td>
                    <td>
                      <Form.Control
                        value={row.vec_other}
                        onChange={(e) =>
                          handleVehicleChange(
                            index,
                            "vec_other",
                            e.target.value
                          )
                        }
                      />
                    </td>
                    <td>
                      <Button
                        variant="danger"
                        size="sm"
                        onClick={() => deleteVehicleRow(index)}
                      >
                        Delete
                      </Button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </Table>
            <Button className="nd-born-thead" onClick={addVehicleRow}>
              + Add Row
            </Button>

            {/* Electricity & Water */}
            <h5 className="text-center mt-3">рдмрд┐рдЬрд▓реА/рдкрд╛рдиреА рдмрд┐рд▓ рд╡рд┐рд╡рд░рдг</h5>
            <Table bordered responsive className="nd-born-table">
              <thead className="nd-born-thead">
                <tr>
                  <th>рдХреНрд░рдорд╛рдВрдХ</th>
                  <th>рдмрд┐рд▓ рдкреНрд░рдХрд╛рд░</th>
                  <th>рдЦрд╛рддрд╛ рд╕рдВрдЦреНрдпрд╛</th>
                  <th>рддрд┐рдерд┐</th>
                  <th>рдзрдирд░рд╛рд╢рд┐ (тВ╣)</th>
                </tr>
              </thead>
              <tbody>
                {electricityRows.map((row, index) => (
                  <tr key={`elec-${index}`}>
                    <td>{index + 1}</td>
                    <td>рдмрд┐рдЬрд▓реА</td>
                    <td>
                      <Form.Control
                        value={row.acno}
                        onChange={(e) =>
                          handleElectricityChange(index, "acno", e.target.value)
                        }
                      />
                    </td>
                    <td>
                      <Form.Control
                        type="date"
                        value={row.date}
                        onChange={(e) =>
                          handleElectricityChange(index, "date", e.target.value)
                        }
                      />
                    </td>
                    <td>
                      <Form.Control
                        type={isNaN(row.amount) ? "text" : "number"}
                        value={row.amount}
                        onChange={(e) =>
                          handleElectricityChange(
                            index,
                            "amount",
                            e.target.value
                          )
                        }
                      />
                    </td>
                  </tr>
                ))}
                <tr>
                  <td>1</td>
                  <td>рдкрд╛рдиреА</td>
                  <td>
                    <Form.Control
                      value={waterBillRow.acno}
                      onChange={(e) =>
                        handleWaterBillChange("acno", e.target.value)
                      }
                    />
                  </td>
                  <td>
                    <Form.Control
                      type="date"
                      value={waterBillRow.date}
                      onChange={(e) =>
                        handleWaterBillChange("date", e.target.value)
                      }
                    />
                  </td>
                  <td>
                    <Form.Control
                      type={isNaN(waterBillRow.amount) ? "text" : "number"}
                      value={waterBillRow.amount}
                      onChange={(e) =>
                        handleWaterBillChange("amount", e.target.value)
                      }
                    />
                  </td>
                </tr>
              </tbody>
            </Table>

            <div className="text-center mt-3">
              <Button variant="primary" onClick={updateAll}>
                рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
              </Button>
            </div>
          </Form>
        </Modal.Body>

        <Modal.Footer>
          <Button variant="secondary" onClick={handleClose}>
            Close
          </Button>
        </Modal.Footer>
      </Modal>
    </>
  );
};

export default TwelfthStepThreeView;
